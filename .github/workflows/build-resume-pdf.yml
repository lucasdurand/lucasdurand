name: Build HTML and Export PDF

on:
  workflow_dispatch:
  push:
    branches: ["*"]
    paths-ignore:
      - "**.pdf"
      - "README*.md"
    paths:
      - "**.md"
      - "_static/**"
      - "_ext/**"
      - ".github/workflows/build-resume-pdf.yml"

permissions:
  contents: write

jobs:
  html_to_pdf:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [AI, RESUME]
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      # --- Build step (Python / uv / env vars) ---
      - name: Setup env for profile
        uses: astral-sh/setup-uv@v7
        run: |
          echo "JB_${{ matrix.profile }}=1" >> "$GITHUB_ENV"

      - name: Build resume
        run: |
          sh scripts/build_resume.sh

      # ---- PDF step (Playwright) ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright
        run: |
          npm i -D playwright
          npx playwright install --with-deps chromium

      - name: Render PDF
        run: |
          node scripts/html_to_pdf.mjs ./_build/html/index.html ./Lucas\ Durand-${{ matrix.profile }}.pdf

      # --- Upload artifact ---
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdf
          path: ./Lucas\ Durand-${{ matrix.profile }}.pdf
          if-no-files-found: error

  commit_outputs:
    if: github.ref == 'refs/heads/main' # only run on main branch
    needs: html_to_pdf
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: /tmp/resumes

      - name: Move downloaded PDFs into repo
        run: |
          mkdir -p artifacts/resume
          find /tmp/resumes -name '*.pdf' -maxdepth 3 -print -exec cp {} ./ \;

      - name: Commit outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add artifacts/resume/*.pdf
          git commit -m "Update resume PDFs" || exit 0
          git push
